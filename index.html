<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini App Example</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –¢–í–û–ô CSS –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω */
        @font-face {
            font-family: Archive Ukr;
            src: url(ArchiveUkr.ttf);
        }
        .main { background-color: #ffffff; min-height: 100vh; display: flex; justify-content: center; }
        .elipse { position: relative; display: inline-block; justify-content: center; }
        .btn_grid{}
        .buttons{ display: flex; justify-content: space-between; gap:20%; }
        button{ background-color: #A099F6; color: white; width:40%; flex: 1 0 auto; padding:0 10px; border: 0px solid; border-radius: 10px; }
        .person { position: absolute; left: 50%; top:30%; transform: translate(-50%, -50%); }
        .person img { width: 100%; height: 100%; object-fit: contain; }
        .text{ font-family: Archive Ukr; }
        .loading { text-align: center; padding: 20px; font-family: Archive Ukr; color: #A099F6; font-size: 18px; }
        .completed-badge { background: #4CAF50; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        .error { color: #ff4444 !important; }
        .debug { font-size: 12px; color: #666; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="mainApp" class="main">
        <div class="elipse">
            <div>
                <img src="Ellipse 6.svg" alt="Ellipse"/>
                <img class="person" src="freepik__pixel-art-fulllength-child-wearing-a-unicorn-hat-o__30059 1.svg" alt="Person"/>
            </div>
            <div id="loading" class="loading">üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
            
            <div id="debug-info" style="display:none; text-align:center; margin:20px 0; font-family: Archive Ukr; font-size:14px;">
                <div id="user-id-display"></div>
                <div id="api-status"></div>
            </div>
            
            <div class="btn_grid" id="btnGrid" style="display:none;">
                <div class="buttons">
                    <button class="text" data-category="–î—Ä—É–∂–µ–ª—é–±–Ω–æ—Å—Ç—å">–î—Ä—É–∂–µ–ª—é–±–Ω–æ—Å—Ç—å <span id="count-–¥—Ä—É–∂–µ–ª—é–±–Ω–æ—Å—Ç—å" class="completed-badge">0</span></button>
                    <button class="text" data-category="–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç">–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç <span id="count-–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç" class="completed-badge">0</span></button>
                </div>
                <div class="buttons">
                    <button class="text" data-category="–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å <span id="count-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å" class="completed-badge">0</span></button>
                    <button class="text" data-category="–õ–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç">–õ–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç <span id="count-–ª–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç" class="completed-badge">0</span></button>
                </div>
            </div>
            <button id="creativeBtn" class="text" data-category="–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ" style="display:none;">–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ <span id="count-—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ" class="completed-badge">0</span></button>
        </div>
    </div>

    <script>
        console.log('üöÄ START');
        const tg = window.Telegram.WebApp;
        tg.expand();

        // üî• –®–ê–ì 1: —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ID (–ù–ï –∂–¥–µ–º API)
        const user = tg.initDataUnsafe?.user;
        const userId = user?.id || 123456;
        console.log('üë§ User ID:', userId);
        
        document.getElementById('user-id-display').textContent = `ID: ${userId}`;
        document.getElementById('loading').textContent = `üë§ –ü—Ä–∏–≤–µ—Ç, ID ${userId}!`;

        // üî• –®–ê–ì 2: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ë–ï–ó API (—á–µ—Ä–µ–∑ 2 —Å–µ–∫)
        setTimeout(() => {
            console.log('‚úÖ Buttons ON');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('btnGrid').style.display = 'block';
            document.getElementById('creativeBtn').style.display = 'block';
            document.getElementById('debug-info').style.display = 'block';
            document.getElementById('api-status').textContent = '‚ö†Ô∏è –î–µ–º–æ-—Ä–µ–∂–∏–º (API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)';
        }, 2000);

        // üî• –®–ê–ì 3: –ø—Ä–æ–±—É–µ–º API –ê–°–ò–ù–•–†–û–ù–ù–û (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
        async function tryApi() {
            try {
                console.log('üåê API —Ç–µ—Å—Ç...');
                document.getElementById('api-status').textContent = 'üåê –¢–µ—Å—Ç API...';
                
                const response = await Promise.race([
                    fetch(`https://dobro-school.onrender.com/api/tasks?user_id=${userId}`),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('timeout')), 5000)
                    )
                ]);
                
                const data = await response.json();
                console.log('‚úÖ API OK:', data);
                document.getElementById('api-status').textContent = `‚úÖ ${data.done_tasks?.length || 0} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ`;
                
            } catch (e) {
                console.log('‚ùå API fail:', e.message);
                document.getElementById('api-status').textContent = '‚ö†Ô∏è API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º API —Ç–µ—Å—Ç
        tryApi();

        // üî• –¢–í–û–ò –ú–û–î–ê–õ–ö–ò (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ)
        const categoryToTasks = {
            '–î—Ä—É–∂–µ–ª—é–±–Ω–æ—Å—Ç—å': ['21','22','23','24','25'],
            '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': ['11','12','13','14','15'],
            '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç': ['31','32','33','34','35'],
            '–õ–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç': ['41','42','43','44','45'],
            '–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ': ['51','52','53','54','55']
        };

        document.addEventListener('click', (e) => {
            if (e.target.matches('button[data-category]')) {
                const category = e.target.dataset.category;
                tg.showAlert(`üìã "${category}"\nüì§ –ü–∏—à–∏ @mary_vii –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞!\nID: ${userId}`);
                tg.openTelegramLink(`https://t.me/mary_vii?text=–®–í–î26_${userId}_${category}`);
            }
        });

        console.log('‚úÖ READY');
    </script>
</body>
</html>
